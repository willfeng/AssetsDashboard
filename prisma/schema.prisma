generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assets    Asset[]
  history   History[]
  integrations Integration[]
}

model Asset {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // BANK, STOCK, CRYPTO
  name      String
  
  // Bank specific
  balance   Float?
  currency  String?  // USD, HKD, CNY
  apy       Float?

  // Stock/Crypto specific
  symbol    String?
  quantity  Float?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  snapshots AssetSnapshot[]
}

model AssetSnapshot {
  id        String   @id @default(cuid())
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  date      String   // YYYY-MM-DD
  value     Float    // Total Value (price * quantity)
  price     Float?   // Unit Price at that time
  quantity  Float?   // Quantity at that time

  createdAt DateTime @default(now())

  @@unique([assetId, date])
  @@index([assetId])
}

model History {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date      String   // YYYY-MM-DD
  value     Float
  
  createdAt DateTime @default(now())
  
  @@unique([userId, date]) // One entry per user per day
}

model Integration {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider  String   // "BINANCE", "WALLET_ETH", "WALLET_BTC"
  name      String?  // User defined label, e.g. "Main Wallet"
  apiKey    String   // Encrypted (API Key or Wallet Address)
  apiSecret String?  // Encrypted (Secret or null for wallets)
  extraParams String? // Encrypted JSON (e.g. { passphrase: "..." } for OKX)
  
  isActive  Boolean  @default(true)
  lastSync  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Removed unique constraint on [userId, provider] to allow multiple wallets
  @@index([userId])
}
